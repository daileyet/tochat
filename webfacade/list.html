<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>ToChat List</title>
<link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>
<body>
<div class="container">
	<div class="section">
		<h1>ToChat Room List</h1>
	</div>
	
	<div class="section">
		<div class="row">
			<table border="1" id="room-list" class="responsive-table">
				<thead>
					<tr>
					<th data-field = "name">Name</th>
					<th data-field = "desc">Description</th>
					<th data-field = "owner">Create By</th>
					<th data-field = "">Create On</th>
					<th>&nbsp;</th>
					</tr>
				</thead>
				<tbody>
					<tr>
					<td>Java</td>
					<td>Discuss Java EE & ME</td>
					<td>Dailey</td>
					<td>2016/4/29</td>
					<td><a class="waves-effect waves-light btn">Join</a></td>
					</tr>
				</tbody>
				
				</table>
		</div>
		<div class="row">
			<a name="bottom"></a>
			<a href="#bottom" id="load-more">More</a>
		</div>
	</div>
</div>

<script src="https://code.jquery.com/jquery-1.12.3.min.js" integrity="sha256-aaODHAgvwQW1bFOGXMeX+pC4PZIPsvn2h1sArYOhgXQ=" crossorigin="anonymous"></script>
<script type="text/javascript" src="js/materialize.min.js"></script>
<script>var ws, url = "ws://localhost:8080/tochatserver/room";

function init() {
	$("a#load-more").click(function() {
		var am = {
			mt: 'A01',
			cou: 15,
			of: $(".room-item").length,
			fr: 'Dailey',
			ti: new Date().getTime() + ""
		};
		postToServer(JSON.stringify(am));
	});
	setWebSocket();
}

function cleanUp() {
	if (ws && ws.close) {
		ws.close()
	}
}

function setWebSocket() {
	try {
		if (ws && ws.close) {
			ws.close()
		}
	} catch (e) {
		console.log(e);
	}
	ws = new WebSocket(url);
	ws.onmessage = function(message) {
		var amObj = JSON.parse(message.data);
		if (amObj.co.length > 0) {
			for (var i = 0; i < amObj.co.length; i++) {
				var rmObj = amObj.co[i];
				var strTR = "<tr class='room-item'><td>{name}</td><td>{desc}</td><td>{owner}</td><td>{createon}</td><td><a id='{id}' class='waves-effect waves-light btn' href='#' onclick='joinChat(this)'>Join</a></td>";
				var strTR = strTR.replace('{name}', rmObj['name'])
					.replace('{desc}', rmObj['desc'])
					.replace('{owner}', rmObj['owner'])
					.replace('{createon}', rmObj['createon'])
					.replace('{id}', rmObj['id']);
				$("#room-list tbody").append(strTR);
			}
		}
	};
	ws.onerror = function() {
		console.log("WebSocket occur error.");
	}
}

function joinChat(domBtn) {
	var strRoomId = $(domBtn).attr("id");
	window.location = "/webfacade/chats.html#" + strRoomId;
}

function postToServer(txt) {
	ws.send(txt);
}

function closeConnect() {
	ws.close();
}
window.addEventListener("load", init, false);
window.addEventListener("unload", cleanUp, false);</script>
</body>
</html>