<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<!--  This file has been downloaded from bootdey.com    @bootdey on twitter -->
		<!--  All snippets are MIT license http://bootdey.com/license -->
		<!-- 
    	The codes are free, but we require linking to our web site.
    	Why to Link?
    	A true story: one girl didn't set a link and had no decent date for two years, and another guy set a link and got a top ranking in Google! 
    	Where to Put the Link?
    	home, about, credits... or in a good page that you want
    	THANK YOU MY FRIEND!
    -->
		<title>ToChat Now</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link href="http://netdna.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
		<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
		<link rel="stylesheet" href="css/chats.css" />
	</head>

	<body>

		<div class="container">
			<div class="col-md-12 ">
				<div class="panel">
					<!--Heading-->
					<div class="panel-heading">
						<div class="panel-control">
							<div class="btn-group">
								<button class="btn btn-default" type="button" data-toggle="collapse" data-target="#demo-chat-body"><i class="fa fa-chevron-down"></i></button>
								<button type="button" class="btn btn-default" data-toggle="dropdown"><i class="fa fa-gear"></i></button>
								<ul class="dropdown-menu dropdown-menu-right">
									<li><a href="#">Available</a></li>
									<li><a href="#">Busy</a></li>
									<li><a href="#">Away</a></li>
									<li class="divider"></li>
									<li><a id="demo-connect-chat" href="#" class="disabled-link" data-target="#demo-chat-body">Connect</a></li>
									<li><a id="demo-disconnect-chat" href="#" data-target="#demo-chat-body">Disconect</a></li>
								</ul>
							</div>
						</div>
						<h3 class="panel-title room-title">Chat</h3>
					</div>

					<!--Widget body-->
					<div id="demo-chat-body" class="collapse in">
						<div class="nano has-scrollbar" style="height:380px">
							<div class="nano-content pad-all" tabindex="0" style="right: -17px;">
								<ul class="list-unstyled media-block viewer-content">

								</ul>
							</div>
							<div class="nano-pane">
								<div class="nano-slider" style="height: 141px; transform: translate(0px, 0px);"></div>
							</div>
						</div>

						<!--Widget footer-->
						<div class="panel-footer">
							<div class="row">
								<div class="col-xs-9">
									<input type="text" placeholder="Enter your text" class="form-control chat-input sender-input">
								</div>
								<div class="col-xs-3">
									<button class="btn btn-primary btn-block" type="submit" onclick="postToServer()">Send</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script src="js/jquery-1.10.2.min.js"></script>
		<script src="js/jquery-dateFormat.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="http://netdna.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
		<script src="js/chat.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			var ws, url = "ws://localhost:8080/tochatserver/chat/";

			function init() {
				var room = getRoom();
				if (room == "") {
					window.history.back();
					return;
				}
				$(".room-title").text(room);
				$("input.sender-input").keydown(function(e) {
					if (!e) {
						var e = window.event;
					}
					
					if (e.keyCode == 13) {
						e.preventDefault(); // sometimes useful
						postToServer();
					}
				});
				setWebSocket();
			}

			function getRoom() {
				var room = window.location.hash.replace("#", "");
				return room;
			}

			function cleanUp() {
				if (ws && ws.close) {
					ws.close()
				}
			}

			function setWebSocket() {
				try {
					if (ws && ws.close) {
						ws.close()
					}
				} catch (e) {
					console.log(e);
				}
				ws = new WebSocket(url + getRoom());
				ws.onmessage = function(message) {
					var amObj = JSON.parse(message.data);
					console.log(message.data);
					switch (amObj.mt) {
						case "C00":
							var chObj = amObj;
							var strLi = chat_V.templates.autoApply(chObj);
							$(".viewer-content").append(strLi);
							break;
						case "C01":
							var chObj_users = amObj.users;
							chat_M.updateOnlineUsers(chObj_users);
							for (var i = 0; i < chObj_users.length; i++) {
								var strMsg = "<div class='item' data-id='{id}'>{name}</div>";
								var userObj = chObj_users[i];
								strMsg = strMsg.replace("{id}", userObj.id);
								strMsg = strMsg.replace("{name}", userObj.name);
								var $strMsg = $(strMsg);
								if (window.tochat.Chat.M.current_user) {
									if (userObj.id == window.tochat.Chat.M.current_user.id) {
										$strMsg.addClass("is-current-user");
									}
								}
								//$("#siderbar .user-list .content").append($strMsg);
							}
							break;
						case "C02":
							break;
						case "B00":
							var userObj = amObj.user;
							window.tochat.Chat.M.current_user = userObj;
							break;
						default:
							break;
					}
				};
				ws.onerror = function() {
					console.log("WebSocket occur error.");
				}
			}

			function getCurrentUser() {
				if (window.tochat.Chat.M.current_user) {
					return window.tochat.Chat.M.current_user;
				} else {
					return {};
				}
			}

			function postToServer(txt) {
				if (ws && ws.readyState == 1) {
					if (txt == undefined) {
						var cuObj = getCurrentUser(),
							sUid = cuObj ? cuObj.id : '';
						var cm = ChatMessage.create({
							id: "1",
							from: sUid,
							to: "",
							room: getRoom(),
							content: encodeURI($(".sender-input").val())
						});
						txt = cm.format();
					}
					console.log(txt);
					ws.send(txt);
					$(".sender-input").val("");
				}
			}
			window.addEventListener("load", init, false);
			window.addEventListener("unload", cleanUp, false);

			function ChatMessage() {
				this.id = "";
				this.from = "";
				this.to = "";
				this.room = "";
				this.timestamp = new Date().getTime() + "";
				this.content = "";
				this.format = function() {
					return '{"mt":"C00","id":"' + this.id + '","ro":"' + this.room + '","fr":"' + this.from + '","to":"' + this.to + '","co":"' + this.content + '","ti":"' + this.timestamp + '"}';
				}
			};
			ChatMessage.create = function(obj) {
				var cm = new ChatMessage();
				if (obj == undefined) return cm;
				for (var i in obj) {
					cm[i] = obj[i];
				}
				return cm;
			}
		</script>
	</body>

</html>