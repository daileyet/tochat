<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>ToChat Now</title>
		<link rel="stylesheet" href="css/chat.css" />
		<script src="https://code.jquery.com/jquery-1.12.3.min.js" crossorigin="anonymous"></script>
	</head>

	<body>

		<section id="top"><span class="room-name" title="Chat Room">{Chat Room title}</span></section>
		<section id="main">
			<section id="messages">
				<section id="viewer">
					<div>
						<div class="viewer-title">Title</div>
						<div class="viewer-content">

						</div>
					</div>
				</section>
				<section id="sender">
					<div class="sender-toolbar">Toolbar</div>
					<div class="sender-input" contenteditable="true"></div>
					<div class="sender-options">
						<div class="float-left"></div>
						<div class="float-right"><button onclick="postToServer()">Send</button></div>
					</div>
				</section>
			</section>
			<section id="siderbar">
				<div class="user-list">
					<div class="title">Users</div>
					<div class="content">
						
					</div>
				</div>
			</section>
		</section>
		<section id="bottom"></section>
		<script type="text/javascript">
			var ws, url = "ws://localhost:8080/tochatserver/chat/";

			function init() {
				var room = getRoom();
				if (room == "") {
					window.history.back();
					return;
				}
				$("#top .room-name").text(room);
				setWebSocket();
			}

			function getRoom() {
				var room = window.location.hash.replace("#", "");
				return room;
			}

			function cleanUp() {
				if (ws && ws.close) {
					ws.close()
				}
			}

			function setWebSocket() {
				try {
					if (ws && ws.close) {
						ws.close()
					}
				} catch (e) {
					console.log(e);
				}
				ws = new WebSocket(url + getRoom());
				ws.onmessage = function(message) {
					var amObj = JSON.parse(message.data);
					console.log(message.data);
					switch (amObj.mt) {
						case "C00":
							var strMsg = "<div>From:{fr}, at:{ti}<BR>{co}</div>";
							var chObj = amObj;
							strMsg = strMsg.replace("{fr}", chObj["fr"]);
							strMsg = strMsg.replace("{ti}", chObj["ti"]);
							strMsg = strMsg.replace("{co}", decodeURI(chObj["co"]));
							$("#viewer .viewer-content").append(strMsg);
							break;
						case "C01":
							var strMsg = "<div class='item' id='{id}'>{name}</div>";
							var chObj_user = amObj.user;
							strMsg = strMsg.replace("{id}",chObj_user.id);
							strMsg = strMsg.replace("{name}",chObj_user.name);
							$("#siderbar .user-list .content").append(strMsg);
						break;
						case "C02":
						break;
						default:
							break;
					}
				};
				ws.onerror = function() {
					console.log("WebSocket occur error.");
				}
			}

			function postToServer(txt) {
				if (ws && ws.readyState == 1) {
					if (txt == undefined) {
						var cm = ChatMessage.create({
							id: "1",
							from: "U1",
							to: "",
							room: getRoom(),
							content: encodeURI($("#sender .sender-input").html())
						});
						txt = cm.format();
					}
					console.log(txt);
					ws.send(txt);
					$("#sender .sender-input").empty();
				}
			}
			window.addEventListener("load", init, false);
			window.addEventListener("unload", cleanUp, false);

			function ChatMessage() {
				this.id = "";
				this.from = "";
				this.to = "";
				this.room = "";
				this.timestamp = new Date().getTime() + "";
				this.content = "";
				this.format = function() {
					return '{"mt":"C00","id":"' + this.id + '","ro":"' + this.room + '","fr":"' + this.from + '","to":"' + this.to + '","co":"' + this.content + '","ti":"' + this.timestamp + '"}';
				}
			};
			ChatMessage.create = function(obj) {
				var cm = new ChatMessage();
				if (obj == undefined) return cm;
				for (var i in obj) {
					cm[i] = obj[i];
				}
				return cm;
			}
		</script>
	</body>

</html>