<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>ToChat Now</title>
		<script src="https://code.jquery.com/jquery-1.12.3.min.js" integrity="sha256-aaODHAgvwQW1bFOGXMeX+pC4PZIPsvn2h1sArYOhgXQ=" crossorigin="anonymous"></script>
	</head>

	<body>

		<section id="top"><span title="Chat Room">{Chat Room title}</span></section>
		<section id="main">
			<section id="messages">
				<section id="viewer">
					<div>
						<div class="viewer-title">{from}</div>
						<div class="viewer-content">
							{message}
						</div>
					</div>
				</section>
				<section id="sender">
					<div class="sender-toolbar">Toolbar</div>
					<div class="sender-input" contenteditable="true">
						{send messages}
					</div>
					<div class="sender-options">
						<button onclick="postToServer()">Send</button>
					</div>
				</section>
			</section>
			<section id="siderbar"></section>
		</section>
		<section id="bottom"></section>
		<script type="text/javascript">
			var ws, url = "ws://localhost:8080/tochatserver/chat/";

			function init() {
				var room = getRoom();
				if (room == "") {
					window.history.back();
					return;
				}
				setWebSocket();
			}

			function getRoom() {
				var room = window.location.hash.replace("#", "");
				return room;
			}

			function cleanUp() {
				if (ws && ws.close) {
					ws.close()
				}
			}

			function setWebSocket() {
				try {
					if (ws && ws.close) {
						ws.close()
					}
				} catch (e) {
					console.log(e);
				}
				ws = new WebSocket(url + getRoom());
				ws.onmessage = function(message) {
					var amObj = JSON.parse(message.data);
					if (amObj.co.length > 0) {
						for (var i = 0; i < amObj.co.length; i++) {
							var strMsg = "<div>From:{fr}>, at:{ti}<BR>{co}</div>";
							var rmObj = amObj.co[i];
							strMsg = strMsg.replace("{fr}", rmObj["fr"]);
							strMsg = strMsg.replace("{ti}", rmObj["ti"]);
							strMsg = strMsg.replace("{co}", rmObj["co"]);
							$("#viewer .viewer-content").append(strMsg);
						}
					}
				};
				ws.onerror = function() {
					console.log("WebSocket occur error.");
				}
			}

			function postToServer(txt) {
				if (ws && ws.readyState == 1) {
					if (txt == undefined) {
						var cm = ChatMessage.create({
							id: "1",
							from: "dailey",
							to: "",
							room: getRoom(),
							content: document.getElementById("#sender .sender-input").value
						});
						txt = JSON.stringify(cm);
					}
					ws.send(txt);
				}
			}
			window.addEventListener("load", init, false);
			window.addEventListener("unload", cleanUp, false);

			function ChatMessage() {
				this.id = "";
				this.from = "";
				this.to = "";
				this.room = "";
				this.timestamp = new Date().getTime() + "";
				this.content = "";
				this.format = function() {
					return '{"mt":"C00","id":"' + this.id + '","ro":"' + this.room + '","fr":"' + this.from + '","to":"' + this.to + '","co":"' + this.content + '","ti":"' + this.timestamp + '"}';
				}
			};
			ChatMessage.create = function(obj) {
				var cm = new ChatMessage();
				if (obj == undefined) return cm;
				for (var i in obj) {
					cm[i] = obj[i];
				}
				return cm;
			}
		</script>
	</body>

</html>